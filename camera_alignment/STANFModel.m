close all;
clear all;

x = [196.8120,    52.7801, 1.0;
     185.9378,    97.4600, 1.0;
     227.1381,    38.4914, 1.0;
     206.1453,   103.4962, 1.0;
     204.3704,   157.9388, 1.0;
     198.8696,    79.1571, 1.0;
     250.4824,    39.9261, 1.0;
     280.1432,   139.1748, 1.0;
     241.8560,    46.6588, 1.0;
     249.2965,    25.2411, 1.0;
     257.1151,   204.9826, 1.0;
     198.1321,   111.1654, 1.0;
     226.1158,   128.1219, 1.0;
     176.8027,    79.6620, 1.0;
     199.1734,   121.4506, 1.0;
     179.7567,    91.2225, 1.0;
     220.5826,    80.2686, 1.0;
     254.7935,   211.1102, 1.0;
     257.3823,   198.6174, 1.0;
     179.8486,   117.0626, 1.0;
     188.5283,   108.9792, 1.0;
     191.3408,   138.0984, 1.0;
     221.9595,   106.0130, 1.0;
     166.0449,   109.1107, 1.0;
     164.7687,   107.3830, 1.0;
     217.5643,   134.2629, 1.0;
     184.8041,   131.4952, 1.0;
     253.5831,   188.4510, 1.0;
     181.9215,    68.3720, 1.0;
     194.3690,   127.8710, 1.0;
     129.1911,   225.0329, 1.0;
     251.3896,   188.7072, 1.0;
     195.1933,    93.3912, 1.0;
     271.5982,   138.6167, 1.0;
     245.6395,    90.0296, 1.0;
     244.7745,   200.8578, 1.0;
     204.0487,   102.8697, 1.0;
     201.8965,   137.7979, 1.0;
     267.6637,    83.0961, 1.0;
     271.0299,   221.0731, 1.0;
     253.3703,   203.3996, 1.0;
     173.0567,   133.3766, 1.0;
     266.9323,   191.8862, 1.0;
     268.9524,   206.2743, 1.0;
     255.3816,   188.8558, 1.0;
     238.7604,   225.2768, 1.0;
     266.1286,   187.0461, 1.0;
     188.0893,   113.9954, 1.0]';

xp = [177.9248,    51.1634, 1.0;
      165.9662,    96.3985, 1.0;
      209.7127,    38.0998, 1.0;
      188.5015,   103.0356, 1.0;
      186.1846,   155.8739, 1.0;
      180.2560,    77.7382, 1.0;
      243.1938,    39.9053, 1.0;
      271.0840,   138.8104, 1.0;
      234.9161,    46.3833, 1.0;
      243.0300,    25.0132, 1.0;
      238.2312,   203.8984, 1.0;
      178.1911,   110.1382, 1.0;
      207.5074,   126.7412, 1.0;
      156.9791,    78.7761, 1.0;
      179.6129,   120.5365, 1.0;
      159.8706,    90.2169, 1.0;
      203.2863,    79.8425, 1.0;
      235.8999,   209.7359, 1.0;
      239.1215,   198.0190, 1.0;
      160.0984,   115.6038, 1.0;
      168.5789,   108.0635, 1.0;
      171.6955,   136.9613, 1.0;
      204.8121,   105.6817, 1.0;
      146.4507,   108.0395, 1.0;
      144.9408,   106.3458, 1.0;
      199.2968,   133.5775, 1.0;
      164.9578,   130.3698, 1.0;
      234.8232,   187.2740, 1.0;
      162.3514,    67.3761, 1.0;
      174.6611,   126.8727, 1.0;
      111.2000,   223.7443, 1.0;
      232.5590,   187.3437, 1.0;
      175.4510,    92.4201, 1.0;
      262.4523,   138.1351, 1.0;
      238.1552,    88.6110, 1.0;
      225.8935,   199.9055, 1.0;
      184.7442,   101.8993, 1.0;
      182.6730,   137.2139, 1.0;
      259.6233,    82.5002, 1.0;
      251.9723,   218.6209, 1.0;
      234.3885,   202.6143, 1.0;
      154.3468,   132.9195, 1.0;
      248.0333,   189.0962, 1.0;
      250.0583,   204.3957, 1.0;
      236.9342,   187.7451, 1.0;
      219.8321,   223.8812, 1.0;
      248.0333,   189.0962, 1.0;
      168.1256,   112.9354, 1.0]';

pts1h = x;
pts2h = xp;
 
figure;
scatter(x(1, :), x(2,:)); hold on;
scatter(xp(1, :), xp(2,:)); hold off;


u = x(1, :)';
v = x(2, :)';
up = xp(1, :)';
vp = xp(2, :)';

% solve linear system of equations with pseudo-inverse
A = [up - u, up, vp, -ones(length(up), 1), up.*v, -v.*vp]; %, u.*vp - up.*v];
x = pinv(A)*(vp - v);

% decompose solution into parameters
ch_y = x(1) % percent?
a_z = x(2) % rad2deg(x(2)) % degrees
a_f = x(3) % (x(3) + 1) * 100 % percent
f_a_x = x(4)
a_y_f = x(5)
a_x_f = 0; %x(6);
ch_z_f = 0; %x(7);

params = [ch_y, a_z, a_f, f_a_x, a_y_f, a_x_f, ch_z_f];

f = [0,      -ch_z_f + a_y_f,  ch_y + a_z;
     ch_z_f  -a_x_f,          -1 + a_f;
    -ch_y,    1,               -f_a_x];    

% sampson distance
pfp = (pts2h' * f)'
pfp = pfp .* pts1h
d = sum(pfp, 1) .^ 2

% additional step for sampson distance
epl1 = f * pts1h
epl2 = f' * pts2h
d = d ./ (epl1(1,:).^2 + epl1(2,:).^2 + epl2(1,:).^2 + epl2(2,:).^2);

d


